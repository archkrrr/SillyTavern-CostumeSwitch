<style>
  /* Theme-aware styling for the settings container.
    This now uses SillyTavern's CSS variables to adapt to any theme.
  */
  #costume-switcher-settings {
    /* Removed hardcoded font to inherit from the user's theme */
    padding: 10px;
    border-radius: 8px;
    background-color: var(--bg1); /* Use theme's primary background */
  }

  /* Style for each individual setting block */
  .cs-block {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 6px;
    background-color: var(--bg2); /* Use theme's secondary background */
    border: 1px solid var(--border); /* Use theme's border color */
  }

  /* Styling for helper text */
  #costume-switcher-settings small {
    display: block;
    margin-top: 5px;
    color: var(--text-color-soft); /* Use theme's soft/secondary text color */
    font-size: 0.85em;
  }

  /* Flex container for buttons */
  .cs-flex-container {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  /* Status and error messages using theme colors */
  .cs-status-message, .cs-error-message {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
    font-weight: bold;
    border: 1px solid transparent;
  }
  .cs-status-message {
    background-color: rgba(var(--green-rgb), 0.15);
    color: var(--green);
    border-color: rgba(var(--green-rgb), 0.3);
  }
  .cs-error-message {
    background-color: rgba(var(--red-rgb), 0.15);
    color: var(--red);
    border-color: rgba(var(--red-rgb), 0.3);
    display: none; /* Hidden by default */
  }

  /* Force buttons to inherit the theme's font */
  #costume-switcher-settings .menu_button {
    font-family: inherit;
  }
</style>

<div id="costume-switcher-settings" class="extension_container">
  <div class="inline-drawer is-open">
    <div class="inline-drawer-toggle inline-drawer-header">
      <b>Costume Switcher</b>
      <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
    }
    </div>
    <div class="inline-drawer-content">
      
      <!-- Profile Management Section -->
      <div class="cs-block">
        <label for="cs-profile-select"><b>Profiles</b></label>
        <small>Save and load different configurations for various chats or characters.</small>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <select id="cs-profile-select" class="text_pole" style="flex-grow: 1;"></select>
          <button id="cs-profile-delete" class="menu_button interactable" title="Delete Selected Profile">Delete</button>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <input id="cs-profile-name" class="text_pole" type="text" placeholder="Enter profile name..." style="flex-grow: 1;">
          <button id="cs-profile-save" class="menu_button interactable">Save</button>
        </div>
        <small>Type a new name to create a duplicate profile. Using the existing name will overwrite the current one.</small>
      </div>

      <div class="cs-block">
        <input id="cs-enable" type="checkbox" />
        <label for="cs-enable"><b>Enable Costume Switch</b></label>
        <small>Master toggle for the extension. Uncheck to disable all functionality.</small>
      </div>

      <div class="cs-block">
        <label for="cs-patterns"><b>Character Patterns</b></label>
        <textarea id="cs-patterns" class="text_pole" rows="3" placeholder="Character One&#10;Character Two&#10;/Regular Expression/"></textarea>
        <small>Enter character names, one per line. Supports simple names or /regex/.</small>
      </div>

      <div class="cs-block">
        <label for="cs-default"><b>Default Costume</b></label>
        <input id="cs-default" class="text_pole" type="text" placeholder="e.g., neutral" />
        <small>The costume folder to use when no character is detected. Leave blank to use the main avatar.</small>
      </div>

      <!-- Advanced settings drawer -->
      <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
          <b>Advanced Settings</b>
          <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">

          <div class="cs-block">
            <label for="cs-ignore-patterns"><b>Ignored Characters</b></label>
            <textarea id="cs-ignore-patterns" class="text_pole" rows="2" placeholder="Char A&#10;/Narrator/"></textarea>
            <small>Any character pattern on this list will be ignored during detection. Useful for temporarily disabling a character.</small>
          </div>

          <div class="cs-block">
            <label for="cs-veto-patterns"><b>Veto Phrases</b></label>
            <textarea id="cs-veto-patterns" class="text_pole" rows="2" placeholder="OOC:&#10;(OOC)"></textarea>
            <small>If any of these phrases or /regex/ patterns are found, the <b>entire message</b> will be ignored, preventing any switch.</small>
          </div>

          <div class="cs-block">
            <label><b>Detection Methods (for Novel Style)</b></label>
            <small>Enable these for flexible detection in narrative text. For simple `Name: "Dialogue"` script style, uncheck all of them.</small>
            <table style="width: 100%; margin-top: 15px; border-spacing: 0 12px; border-collapse: separate;">
              <tbody>
                <tr>
                  <td style="width: 35%; vertical-align: top;"><input id="cs-detect-attribution" type="checkbox" /><label for="cs-detect-attribution"> Detect Attribution</label></td>
                  <td><small>Finds dialogue attribution, like <em>"Hello," she said.</em></small></td>
                </tr>
                <tr>
                  <td style="vertical-align: top;"><input id="cs-detect-action" type="checkbox" /><label for="cs-detect-action"> Detect Action</label></td>
                  <td><small>Finds character actions, like <em>He nodded.</em></small></td>
                </tr>
                <tr>
                  <td style="vertical-align: top;"><input id="cs-detect-vocative" type="checkbox" /><label for="cs-detect-vocative"> Detect Vocative</label></td>
                  <td><small>Finds when a character is addressed by name.</small></td>
                </tr>
                <tr>
                  <td style="vertical-align: top;"><input id="cs-detect-possessive" type="checkbox" /><label for="cs-detect-possessive"> Detect Possessive</label></td>
                  <td><small>Finds ownership, like <em>Her eyes widened.</em></small></td>
                </tr>
                <tr>
                  <td style="vertical-align: top;"><input id="cs-detect-general" type="checkbox" /><label for="cs-detect-general"> Detect General Mentions</label></td>
                  <td><small><b>(Use with caution)</b> Triggers on any name mention. Can be inaccurate.</small></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="cs-block">
            <label><b>Performance Tuning</b></label>
            <div class="inline-group" style="margin-top: 10px;">
              <label for="cs-global-cooldown">Global Cooldown (ms)</label>
              <input id="cs-global-cooldown" class="text_pole" type="number" min="0" />
              <small>Minimum time between any two switches to prevent flickering.</small>
            </div>
            <div class="inline-group" style="margin-top: 10px;">
              <label for="cs-repeat-suppress">Repeat Suppression (ms)</label>
              <input id="cs-repeat-suppress" class="text_pole" type="number" min="0" />
              <small>Minimum time before the *same* character can trigger another switch.</small>
            </div>
            <!-- NEW SETTING ADDED HERE -->
            <div class="inline-group" style="margin-top: 10px;">
              <label for="cs-token-process-threshold">Token Process Threshold (chars)</label>
              <input id="cs-token-process-threshold" class="text_pole" type="number" min="0" />
              <small>How many characters to wait for before checking. Lower is more reactive but uses more CPU. Higher is smoother but may react slower.</small>
            </div>
          </div>

          <div class="cs-block">
            <label for="cs-mappings"><b>Costume Mappings</b></label>
            <small>Map a detected name to a specific costume folder.</small>
            <table id="cs-mappings" class="text_pole" style="margin-top: 10px;">
              <thead><tr><th>Character Name</th><th>Costume Folder</th><th>Action</th></tr></thead>
              <tbody id="cs-mappings-tbody"></tbody>
            </table>
            <button id="cs-mapping-add" class="menu_button interactable">Add Mapping</button>
          </div>

          <div class="cs-block">
            <label><b>Live Pattern Tester</b></label>
            <small>Paste text to see detections based on your current settings.</small>
            <textarea id="cs-regex-test-input" class="text_pole" rows="4" placeholder="Paste a message here..." style="margin-top: 10px;"></textarea>
            <button id="cs-regex-test-button" class="menu_button interactable">Test Pattern</button>
            <div id="cs-regex-test-output-container" class="text_pole" style="display: flex; gap: 10px; padding: 10px; min-height: 100px; margin-top: 10px; background-color: var(--bg0);">
              <div style="flex: 1; border-right: 1px solid var(--border); padding-right: 10px;">
                <div style="font-weight: bold; margin-bottom: 5px;">All Detections (in order):</div>
                <ul id="cs-test-all-detections" style="list-style-position: inside; padding: 0; margin: 0; font-size: 0.9em;">
                  <li style="color: var(--text-color-soft);">Results will appear here.</li>
                </ul>
              </div>
              <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 5px;">Winning Detections (in order):</div>
                <ul id="cs-test-winner-list" style="list-style-position: inside; padding: 0; margin: 0; font-size: 0.9em;">
                  <li style="color: var(--text-color-soft);">N/A</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="cs-block">
            <input id="cs-debug" type="checkbox" />
            <label for="cs-debug"><b>Enable Debug Logging</b></label>
            <small>Logs details to the browser console (F12) for troubleshooting.</small>
          </div>

        </div>
      </div>

      <div class="cs-flex-container">
        <button id="cs-save" class="menu_button interactable">Save Current Profile</button>
        <button id="cs-reset" class="menu_button interactable">Manual Reset</button>
      </div>

      <div id="cs-status" class="cs-status-message">Ready</div>
      <div id="cs-error" class="cs-error-message"></div>
    </div>
  </div>
</div>
